<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Utility Suite — SPA</title>

<!-- Inter font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Favicon: tiny SVG data URI -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect rx='18' width='100' height='100' fill='%2322c55e'/%3E%3Ctext x='50' y='58' font-family='Inter,Arial' font-weight='700' font-size='50' fill='white' text-anchor='middle'%3EU%3C/text%3E%3C/svg%3E">

<style>
  :root{
    --bg:#0b0f11;
    --panel:#0f1518;
    --muted:#9aa5a9;
    --accent:#22c55e;
    --glass: rgba(255,255,255,0.03);
    --card:#0d1112;
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,#071014 0%, #071417 100%);
    color:#e6eef0;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:20px;
    display:grid;
    place-items:center;
  }

  .app{
    width:100%;
    max-width:1100px;
    min-height:640px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;
    display:grid;
    grid-template-columns: 240px 1fr;
    gap:20px;
    padding:18px;
    box-shadow: 0 10px 40px rgba(2,6,8,0.6);
    border: 1px solid rgba(255,255,255,0.03);
  }

  /* Sidebar */
  .sidebar{
    background:var(--panel);
    border-radius:12px;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:520px;
  }
  .brand{
    display:flex;
    gap:10px;
    align-items:center;
    padding:6px 8px;
  }
  .logo{
    width:36px;height:36px;border-radius:8px;background:var(--accent);display:grid;place-items:center;font-weight:700;color:#041014;
  }
  .title{font-weight:600;font-size:16px}
  .subtitle{font-size:12px;color:var(--muted)}

  .nav{
    margin-top:6px;display:flex;flex-direction:column;gap:6px;padding:6px;
  }
  .nav button{
    text-align:left;
    background:transparent;border:none;padding:10px;border-radius:10px;color:inherit;
    width:100%;cursor:pointer;font-weight:500;
  }
  .nav button:hover{background:rgba(255,255,255,0.02)}
  .nav button.active{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:inset 0 -1px 0 rgba(255,255,255,0.02)}

  .footer{
    margin-top:auto;
    font-size:12px;color:var(--muted);
    display:flex;align-items:center;justify-content:space-between;
  }

  /* Content */
  .content{
    background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    border-radius:12px;padding:16px;min-height:520px;
    overflow:auto;
  }
  .tool{
    display:none;
  }
  .tool.active{display:block}

  h1{margin:0 0 8px 0;font-weight:600}
  .row{display:flex;gap:10px;align-items:center;}
  .card{
    background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);
  }

  input,select,textarea,button{
    font-family:inherit;font-size:14px;color:inherit;
  }
  input[type="text"], input[type="number"], select, textarea{
    background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:inherit;
    width:100%;
  }

  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px}

  /* Calculator */
  .calc{
    display:grid;grid-template-columns:1fr 120px;gap:12px;
  }
  .display{background:rgba(0,0,0,0.15);padding:12px;border-radius:8px;font-size:20px;text-align:right;min-height:48px}
  .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  .keys button{padding:14px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);cursor:pointer;font-weight:600}

  /* To-do list */
  .todo-list{display:flex;flex-direction:column;gap:8px}
  .todo-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
  .todo-item.done{opacity:0.6;text-decoration:line-through}

  /* nice small helpers */
  .muted-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;cursor:pointer}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px}

  /* responsive */
  @media (max-width:880px){
    .app{grid-template-columns:1fr; padding:12px}
    .sidebar{flex-direction:row;overflow:auto;min-height:auto}
    .nav{display:flex;flex-direction:row;gap:6px}
    .content{margin-top:12px}
  }
</style>
</head>
<body>
  <div class="app" role="application">
    <aside class="sidebar" aria-label="Sidebar">
      <div class="brand">
        <div class="logo">U</div>
        <div>
          <div class="title">Utility Suite</div>
          <div class="subtitle">Quick tools — SPA</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button data-route="home" class="active">Home</button>
        <button data-route="calculator">Calculator</button>
        <button data-route="converter">Unit Converter</button>
        <button data-route="todo">To-Do</button>
        <button data-route="notes">Notes</button>
        <button data-route="stopwatch">Stopwatch & Timer</button>
        <button data-route="password">Password Gen</button>
        <button data-route="json">JSON Formatter</button>
        <button data-route="base64">Base64</button>
        <button data-route="color">Color Picker</button>
        <button data-route="settings">Settings</button>
      </nav>

      <div class="footer">
        <div>
          <div class="small muted">Local & offline</div>
          <div class="small muted">Dark theme</div>
        </div>
        <div class="small muted">v1.0</div>
      </div>
    </aside>

    <main class="content" id="content" tabindex="0">
      <!-- HOME -->
      <section id="home" class="tool active">
        <h1>Welcome</h1>
        <p class="muted">Pick a tool on the left. Your data (to-dos & notes & settings) is saved locally in your browser.</p>

        <div style="margin-top:12px" class="grid-2">
          <div class="card">
            <h3 style="margin:0 0 8px 0">Quick actions</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="muted-btn" onclick="navigate('calculator')">Open Calculator</button>
              <button class="muted-btn" onclick="navigate('todo')">Open To-Do</button>
              <button class="muted-btn" onclick="navigate('notes')">Open Notes</button>
              <button class="muted-btn" onclick="navigate('password')">Generate Password</button>
            </div>
          </div>

          <div class="card">
            <h3 style="margin:0 0 8px 0">Clipboard helpers</h3>
            <div class="muted small">Try creating a password then click "Copy". Many tools have copy buttons.</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="muted-btn" onclick="copyText((new Date()).toString())">Copy current time</button>
              <button class="muted-btn" onclick="copyText(location.href)">Copy URL</button>
            </div>
          </div>
        </div>
      </section>

      <!-- CALCULATOR -->
      <section id="calculator" class="tool">
        <h1>Calculator</h1>
        <div class="calc">
          <div>
            <div id="calc-display" class="display">0</div>
            <div class="keys" id="calc-keys">
              <!-- keys will be injected -->
            </div>
          </div>

          <div class="card">
            <h3 style="margin-top:0">History</h3>
            <div id="calc-history" class="muted small" style="max-height:380px;overflow:auto"></div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="muted-btn" onclick="clearCalcHistory()">Clear</button>
              <button class="muted-btn" onclick="copyCalcLast()">Copy Last</button>
            </div>
          </div>
        </div>
      </section>

      <!-- CONVERTER -->
      <section id="converter" class="tool">
        <h1>Unit Converter</h1>
        <div class="grid-2">
          <div class="card">
            <h3 style="margin-top:0">Length</h3>
            <div class="row" style="gap:8px;margin-top:8px">
              <input id="len-input" type="number" placeholder="Value" />
              <select id="len-from">
                <option value="m">meters (m)</option>
                <option value="km">kilometers (km)</option>
                <option value="mi">miles (mi)</option>
                <option value="ft">feet (ft)</option>
              </select>
              <select id="len-to">
                <option value="m">meters (m)</option>
                <option value="km">kilometers (km)</option>
                <option value="mi">miles (mi)</option>
                <option value="ft">feet (ft)</option>
              </select>
            </div>
            <div style="margin-top:8px"><button class="muted-btn" onclick="convertLength()">Convert</button></div>
            <div id="len-result" class="muted" style="margin-top:8px"></div>
          </div>

          <div class="card">
            <h3 style="margin-top:0">Temperature</h3>
            <div class="row" style="gap:8px;margin-top:8px">
              <input id="temp-input" type="number" placeholder="Value" />
              <select id="temp-from">
                <option value="C">°C</option>
                <option value="F">°F</option>
                <option value="K">K</option>
              </select>
              <select id="temp-to">
                <option value="C">°C</option>
                <option value="F">°F</option>
                <option value="K">K</option>
              </select>
            </div>
            <div style="margin-top:8px"><button class="muted-btn" onclick="convertTemp()">Convert</button></div>
            <div id="temp-result" class="muted" style="margin-top:8px"></div>
          </div>

          <div class="card">
            <h3 style="margin-top:0">Weight</h3>
            <div class="row" style="gap:8px;margin-top:8px">
              <input id="wt-input" type="number" placeholder="Value" />
              <select id="wt-from">
                <option value="kg">kg</option>
                <option value="lb">lb</option>
              </select>
              <select id="wt-to">
                <option value="kg">kg</option>
                <option value="lb">lb</option>
              </select>
            </div>
            <div style="margin-top:8px"><button class="muted-btn" onclick="convertWeight()">Convert</button></div>
            <div id="wt-result" class="muted" style="margin-top:8px"></div>
          </div>
        </div>
      </section>

      <!-- TODO -->
      <section id="todo" class="tool">
        <h1>To-Do</h1>
        <div class="card">
          <div style="display:flex;gap:8px">
            <input id="todo-input" type="text" placeholder="Add a to-do..." />
            <button class="muted-btn" onclick="addTodo()">Add</button>
          </div>
          <div class="todo-list" id="todo-list" style="margin-top:12px"></div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="muted-btn" onclick="clearTodos()">Clear All</button>
            <button class="muted-btn" onclick="saveTodos()">Save Now</button>
          </div>
        </div>
      </section>

      <!-- NOTES -->
      <section id="notes" class="tool">
        <h1>Notes</h1>
        <div class="grid-2">
          <div class="card">
            <textarea id="note-input" rows="14" placeholder="Write notes..."></textarea>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="muted-btn" onclick="saveNote()">Save</button>
              <button class="muted-btn" onclick="clearNote()">Clear</button>
              <button class="muted-btn" onclick="copyText(document.getElementById('note-input').value)">Copy</button>
            </div>
          </div>
          <div class="card">
            <h3 style="margin-top:0">Preview</h3>
            <div id="note-preview" style="white-space:pre-wrap;overflow:auto;max-height:420px"></div>
          </div>
        </div>
      </section>

      <!-- STOPWATCH -->
      <section id="stopwatch" class="tool">
        <h1>Stopwatch & Timer</h1>
        <div class="grid-2">
          <div class="card">
            <h3 style="margin-top:0">Stopwatch</h3>
            <div id="sw-display" style="font-size:28px;font-weight:700">00:00:00.000</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="muted-btn" onclick="swStart()">Start</button>
              <button class="muted-btn" onclick="swStop()">Stop</button>
              <button class="muted-btn" onclick="swReset()">Reset</button>
            </div>
            <div id="sw-laps" style="margin-top:8px"></div>
          </div>

          <div class="card">
            <h3 style="margin-top:0">Timer</h3>
            <div style="display:flex;gap:8px">
              <input id="timer-min" type="number" placeholder="min" style="width:88px"/>
              <input id="timer-sec" type="number" placeholder="sec" style="width:88px"/>
            </div>
            <div style="margin-top:8px">
              <button class="muted-btn" onclick="timerStart()">Start</button>
              <button class="muted-btn" onclick="timerStop()">Stop</button>
              <button class="muted-btn" onclick="timerReset()">Reset</button>
            </div>
            <div id="timer-display" style="margin-top:8px;font-weight:700">00:00</div>
          </div>
        </div>
      </section>

      <!-- PASSWORD -->
      <section id="password" class="tool">
        <h1>Password Generator</h1>
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small muted">Length</label>
            <input id="pw-length" type="number" value="16" min="4" max="128" style="width:90px"/>
            <label><input id="pw-lower" type="checkbox" checked/> a-z</label>
            <label><input id="pw-upper" type="checkbox" checked/> A-Z</label>
            <label><input id="pw-digits" type="checkbox" checked/> 0-9</label>
            <label><input id="pw-symbols" type="checkbox" checked/> symbols</label>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="muted-btn" onclick="generatePassword()">Generate</button>
            <button class="muted-btn" onclick="copyText(document.getElementById('pw-out').value)">Copy</button>
          </div>
          <div style="margin-top:8px">
            <input id="pw-out" type="text" readonly />
          </div>
        </div>
      </section>

      <!-- JSON -->
      <section id="json" class="tool">
        <h1>JSON Formatter</h1>
        <div class="grid-2">
          <div class="card">
            <textarea id="json-input" rows="14" placeholder='Paste JSON here...'></textarea>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="muted-btn" onclick="formatJSON()">Format</button>
              <button class="muted-btn" onclick="minifyJSON()">Minify</button>
              <button class="muted-btn" onclick="copyText(document.getElementById('json-output').value)">Copy</button>
            </div>
          </div>
          <div class="card">
            <h3 style="margin-top:0">Output</h3>
            <textarea id="json-output" rows="14" readonly></textarea>
          </div>
        </div>
      </section>

      <!-- BASE64 -->
      <section id="base64" class="tool">
        <h1>Base64 Encode / Decode</h1>
        <div class="grid-2">
          <div class="card">
            <textarea id="b64-input" rows="10" placeholder="Text to encode or decode..."></textarea>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="muted-btn" onclick="b64Encode()">Encode</button>
              <button class="muted-btn" onclick="b64Decode()">Decode</button>
              <button class="muted-btn" onclick="copyText(document.getElementById('b64-output').value)">Copy</button>
            </div>
          </div>
          <div class="card">
            <h3 style="margin-top:0">Output</h3>
            <textarea id="b64-output" rows="10" readonly></textarea>
            <div id="b64-error" class="muted" style="margin-top:8px;color:var(--muted)"></div>
          </div>
        </div>
      </section>

      <!-- COLOR -->
      <section id="color" class="tool">
        <h1>Color Picker</h1>
        <div class="card">
          <div style="display:flex;gap:12px;align-items:center">
            <input id="color-picker" type="color" value="#22c55e" />
            <input id="color-hex" type="text" value="#22c55e" style="width:120px" />
            <button class="muted-btn" onclick="copyText(document.getElementById('color-hex').value)">Copy</button>
          </div>
          <div id="color-sample" style="margin-top:12px;padding:16px;border-radius:8px;background:#071013;color:#dfffe6">Sample text on color</div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="tool">
        <h1>Settings</h1>
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center;">
            <label><input id="setting-save" type="checkbox" /> Auto save notes & todos</label>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="muted-btn" onclick="exportData()">Export data</button>
            <button class="muted-btn" onclick="importData()">Import data</button>
            <button class="muted-btn" onclick="resetApp()">Reset (clear all)</button>
          </div>
          <div style="margin-top:12px" class="muted small">Your data is kept only in your browser via localStorage. Export before clearing if you want backups.</div>
        </div>
      </section>

    </main>
  </div>

<script>
/* ---------- Router ---------- */
const navButtons = document.querySelectorAll('.nav button');
const tools = document.querySelectorAll('.tool');

function activateRoute(route){
  navButtons.forEach(b=>b.classList.toggle('active', b.dataset.route===route));
  tools.forEach(t=>t.classList.toggle('active', t.id===route));
  document.title = route === 'home' ? 'Utility Suite — SPA' : route.charAt(0).toUpperCase()+route.slice(1) + ' — Utility Suite';
}

function navigate(route){
  history.pushState({route}, '', '#'+route);
  activateRoute(route);
}
window.addEventListener('popstate', e => {
  const r = (location.hash && location.hash.slice(1)) || 'home';
  activateRoute(r);
});
navButtons.forEach(b => b.addEventListener('click', ()=>navigate(b.dataset.route)));
if(!location.hash) history.replaceState({route:'home'}, '', '#home');
activateRoute(location.hash.slice(1) || 'home');

/* ---------- Utilities ---------- */
function copyText(text){
  if(!text) return;
  navigator.clipboard?.writeText(text).then(()=>alert('Copied!')).catch(()=>alert('Copy failed'));
}

/* ---------- Calculator ---------- */
const display = document.getElementById('calc-display');
const keysWrap = document.getElementById('calc-keys');
const calcHistoryEl = document.getElementById('calc-history');
let calcExp = '';
let calcHistory = JSON.parse(localStorage.getItem('calcHistory')||'[]');

function renderCalcHistory(){ calcHistoryEl.innerHTML = calcHistory.slice().reverse().map(h=>`<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.02)">${h}</div>`).join(''); }
renderCalcHistory();

const keys = [
  '7','8','9','/',
  '4','5','6','*',
  '1','2','3','-',
  '0','.','=','+',
  '(',')','C','CE'
];
keys.forEach(k=>{
  const btn = document.createElement('button');
  btn.textContent = k;
  btn.addEventListener('click', ()=>handleKey(k));
  keysWrap.appendChild(btn);
});

function handleKey(k){
  if(k==='C'){ calcExp = ''; display.textContent='0'; return;}
  if(k==='CE'){ calcExp = calcExp.slice(0,-1); display.textContent = calcExp || '0'; return;}
  if(k==='='){ evaluateCalc(); return;}
  calcExp += k;
  display.textContent = calcExp;
}

function evaluateCalc(){
  try {
    // Safe-ish parse: allow digits, operators, parentheses, dot, space
    if(!/^[0-9+\-*/().\s%]+$/.test(calcExp)) throw new Error('Invalid chars');
    // handle percent
    const expr = calcExp.replace(/%/g, '/100');
    const result = Function('"use strict";return (' + expr + ')')();
    const out = (typeof result === 'number' && isFinite(result)) ? String(result) : 'NaN';
    calcHistory.push(`${calcExp} = ${out}`);
    if(calcHistory.length>200) calcHistory.shift();
    localStorage.setItem('calcHistory', JSON.stringify(calcHistory));
    renderCalcHistory();
    display.textContent = out;
    calcExp = String(out);
  } catch(e){
    display.textContent = 'Error';
  }
}
function clearCalcHistory(){ if(confirm('Clear calculator history?')){ calcHistory=[]; localStorage.removeItem('calcHistory'); renderCalcHistory(); } }
function copyCalcLast(){ if(calcHistory.length) copyText(calcHistory[calcHistory.length-1]); else alert('No history'); }

/* ---------- Unit Converters ---------- */
function convertLength(){
  const v = parseFloat(document.getElementById('len-input').value||'0');
  const from = document.getElementById('len-from').value;
  const to = document.getElementById('len-to').value;
  const toMeters = {m:1, km:1000, mi:1609.344, ft:0.3048};
  const meters = v * toMeters[from];
  const out = meters / toMeters[to];
  document.getElementById('len-result').textContent = `${out} ${to}`;
}
function convertTemp(){
  const v = parseFloat(document.getElementById('temp-input').value||'0');
  const from = document.getElementById('temp-from').value;
  const to = document.getElementById('temp-to').value;
  function toC(x, f){ if(f==='C')return x; if(f==='F')return (x-32)*5/9; if(f==='K')return x-273.15; }
  function fromC(x, t){ if(t==='C')return x; if(t==='F')return x*9/5+32; if(t==='K')return x+273.15; }
  const c = toC(v, from);
  const out = fromC(c, to);
  document.getElementById('temp-result').textContent = `${out} ${to}`;
}
function convertWeight(){
  const v = parseFloat(document.getElementById('wt-input').value||'0');
  const from = document.getElementById('wt-from').value;
  const to = document.getElementById('wt-to').value;
  const kg = (from==='kg') ? v : v * 0.45359237;
  const out = (to==='kg') ? kg : kg / 0.45359237;
  document.getElementById('wt-result').textContent = `${out} ${to}`;
}

/* ---------- ToDo ---------- */
let todos = JSON.parse(localStorage.getItem('todos')||'[]');
const todoListEl = document.getElementById('todo-list');
function renderTodos(){
  todoListEl.innerHTML = '';
  todos.forEach((t, i)=>{
    const item = document.createElement('div');
    item.className = 'todo-item' + (t.done ? ' done' : '');
    item.innerHTML = `
      <input type="checkbox" ${t.done?'checked':''} onchange="toggleTodo(${i})" />
      <div style="flex:1">${escapeHtml(t.text)}</div>
      <div style="display:flex;gap:6px">
        <button onclick="deleteTodo(${i})" class="muted-btn">Delete</button>
      </div>
    `;
    todoListEl.appendChild(item);
  });
}
function addTodo(){
  const v = document.getElementById('todo-input').value.trim();
  if(!v) return;
  todos.push({text:v,done:false});
  document.getElementById('todo-input').value='';
  saveTodos();
  renderTodos();
}
function toggleTodo(i){ todos[i].done = !todos[i].done; saveTodos(); renderTodos(); }
function deleteTodo(i){ todos.splice(i,1); saveTodos(); renderTodos(); }
function saveTodos(){ localStorage.setItem('todos', JSON.stringify(todos)); alert('Saved'); }
function clearTodos(){ if(confirm('Clear all todos?')){ todos=[]; saveTodos(); renderTodos(); } }
renderTodos();

/* ---------- Notes ---------- */
const noteInput = document.getElementById('note-input');
const notePreview = document.getElementById('note-preview');
noteInput.value = localStorage.getItem('notes') || '';
notePreview.textContent = noteInput.value;
noteInput.addEventListener('input', ()=> notePreview.textContent = noteInput.value);
function saveNote(){ localStorage.setItem('notes', noteInput.value); alert('Saved'); }
function clearNote(){ if(confirm('Clear notes?')){ noteInput.value=''; notePreview.textContent=''; saveNote(); } }

/* ---------- Stopwatch & Timer ---------- */
let swInterval, swStartTs, swElapsed = 0;
function swFormat(ms){
  const d = new Date(ms);
  const hh = String(Math.floor(ms/3600000)).padStart(2,'0');
  const mm = String(d.getUTCMinutes()).padStart(2,'0');
  const ss = String(d.getUTCSeconds()).padStart(2,'0');
  const ms3 = String(ms%1000).padStart(3,'0');
  return `${hh}:${mm}:${ss}.${ms3}`;
}
function swStart(){
  if(swInterval) return;
  swStartTs = Date.now() - swElapsed;
  swInterval = setInterval(()=> {
    swElapsed = Date.now() - swStartTs;
    document.getElementById('sw-display').textContent = swFormat(swElapsed);
  }, 31);
}
function swStop(){ clearInterval(swInterval); swInterval=null; }
function swReset(){ swStop(); swElapsed=0; document.getElementById('sw-display').textContent='00:00:00.000'; document.getElementById('sw-laps').innerHTML=''; }

/* Timer */
let timerInterval, timerRemaining = 0;
function timerStart(){
  const m = parseInt(document.getElementById('timer-min').value||'0',10);
  const s = parseInt(document.getElementById('timer-sec').value||'0',10);
  if(timerInterval) return;
  timerRemaining = (m*60 + s) * 1000;
  if(timerRemaining<=0) { alert('Set a time'); return; }
  const start = Date.now();
  timerInterval = setInterval(()=> {
    const passed = Date.now() - start;
    const left = Math.max(0, timerRemaining - passed);
    const mm = String(Math.floor(left/60000)).padStart(2,'0');
    const ss = String(Math.floor((left%60000)/1000)).padStart(2,'0');
    document.getElementById('timer-display').textContent = `${mm}:${ss}`;
    if(left<=0){ clearInterval(timerInterval); timerInterval=null; alert('Timer finished'); }
  }, 250);
}
function timerStop(){ clearInterval(timerInterval); timerInterval=null; }
function timerReset(){ timerStop(); timerRemaining=0; document.getElementById('timer-display').textContent='00:00'; }

/* ---------- Password Generator ---------- */
function generatePassword(){
  const len = Math.max(4, Math.min(128, parseInt(document.getElementById('pw-length').value||16)));
  const hasLower = document.getElementById('pw-lower').checked;
  const hasUpper = document.getElementById('pw-upper').checked;
  const hasDigits = document.getElementById('pw-digits').checked;
  const hasSymbols = document.getElementById('pw-symbols').checked;
  let pool = '';
  if(hasLower) pool += 'abcdefghijklmnopqrstuvwxyz';
  if(hasUpper) pool += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  if(hasDigits) pool += '0123456789';
  if(hasSymbols) pool += '!@#$%^&*()-_=+[]{};:,.<>/?';
  if(!pool) { alert('Select at least one charset'); return; }
  let pw = '';
  const cryptoObj = window.crypto || window.msCrypto;
  const rand = new Uint32Array(len);
  cryptoObj.getRandomValues(rand);
  for(let i=0;i<len;i++){ pw += pool[rand[i] % pool.length]; }
  document.getElementById('pw-out').value = pw;
}

/* ---------- JSON Formatter ---------- */
function formatJSON(){
  const t = document.getElementById('json-input').value;
  try {
    const obj = JSON.parse(t);
    document.getElementById('json-output').value = JSON.stringify(obj, null, 2);
  } catch(e){
    alert('Invalid JSON: ' + e.message);
  }
}
function minifyJSON(){
  const t = document.getElementById('json-input').value;
  try {
    const obj = JSON.parse(t);
    document.getElementById('json-output').value = JSON.stringify(obj);
  } catch(e){
    alert('Invalid JSON: ' + e.message);
  }
}

/* ---------- Base64 ---------- */
function b64Encode(){ try{ const out = btoa(unescape(encodeURIComponent(document.getElementById('b64-input').value||''))); document.getElementById('b64-output').value = out; document.getElementById('b64-error').textContent=''; } catch(e){ document.getElementById('b64-error').textContent = 'Encode error'; } }
function b64Decode(){ try{ const out = decodeURIComponent(escape(atob(document.getElementById('b64-input').value||''))); document.getElementById('b64-output').value = out; document.getElementById('b64-error').textContent=''; } catch(e){ document.getElementById('b64-error').textContent = 'Decode error'; } }

/* ---------- Color Picker ---------- */
const colorPicker = document.getElementById('color-picker');
const colorHex = document.getElementById('color-hex');
const colorSample = document.getElementById('color-sample');
colorPicker.addEventListener('input', ()=> { colorHex.value = colorPicker.value; updateColorSample(); });
colorHex.addEventListener('change', ()=> { let v = colorHex.value.trim(); if(!v.startsWith('#')) v = '#'+v; colorHex.value=v; colorPicker.value=v; updateColorSample();});
function updateColorSample(){ colorSample.style.background = colorPicker.value; colorSample.style.color = (luma(colorPicker.value) > 180) ? '#071014' : '#dfffe6'; }
function luma(hex){
  const c = hex.replace('#','');
  const r = parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
  return 0.299*r + 0.587*g + 0.114*b;
}
updateColorSample();

/* ---------- Settings / Backup ---------- */
document.getElementById('setting-save').checked = localStorage.getItem('autosave') === '1';
document.getElementById('setting-save').addEventListener('change', (e)=> localStorage.setItem('autosave', e.target.checked ? '1':'0'));

function exportData(){
  const data = {
    notes: localStorage.getItem('notes')||'',
    todos: JSON.parse(localStorage.getItem('todos')||'[]'),
    calcHistory: JSON.parse(localStorage.getItem('calcHistory')||'[]'),
    settings: { autosave: localStorage.getItem('autosave')||'0' }
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'utility-suite-backup.json'; a.click();
  URL.revokeObjectURL(url);
}

function importData(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    const rdr = new FileReader();
    rdr.onload = ev => {
      try{
        const obj = JSON.parse(ev.target.result);
        if(obj.notes) localStorage.setItem('notes', obj.notes);
        if(obj.todos) localStorage.setItem('todos', JSON.stringify(obj.todos));
        if(obj.calcHistory) localStorage.setItem('calcHistory', JSON.stringify(obj.calcHistory));
        if(obj.settings && obj.settings.autosave) localStorage.setItem('autosave', obj.settings.autosave);
        alert('Imported');
        location.reload();
      }catch(err){ alert('Invalid file'); }
    };
    rdr.readAsText(f);
  };
  inp.click();
}

function resetApp(){
  if(confirm('Reset app? This clears local data.')){ localStorage.clear(); location.reload(); }
}

/* ---------- Helpers ---------- */
function escapeHtml(s){ return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* Auto-save hook (if enabled) */
if(localStorage.getItem('autosave')==='1'){
  window.addEventListener('beforeunload', ()=> {
    localStorage.setItem('notes', noteInput.value);
    localStorage.setItem('todos', JSON.stringify(todos));
  });
}

/* small shim for accessibility */
document.getElementById('content').addEventListener('keydown', e=>{
  if(e.key === 'Escape') { navigate('home'); }
});

</script>
</body>
</html>
