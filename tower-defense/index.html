<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Tower Defense</title>
    <style>
        body { margin: 0; background: #0a0a0c; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; user-select: none; display: flex; }
        canvas { display: block; background: #0a0a0c; cursor: crosshair; }
        #ui-top { position: absolute; top: 10px; left: 10px; display: flex; gap: 10px; pointer-events: none; z-index: 10; }
        .stat-box { background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; border: 1px solid #444; font-weight: bold; font-size: 16px; box-shadow: 0 0 15px rgba(0, 255, 204, 0.1); backdrop-filter: blur(5px); }
        #shop-container { width: 150px; height: 100vh; background: #151518; border-left: 2px solid #333; display: flex; flex-direction: column; z-index: 20; }
        #stats-panel { background: #1e272e; padding: 15px; font-size: 12px; border-bottom: 1px solid #333; color: #d1d8e0; min-height: 140px; line-height: 1.5; }
        #shop { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; align-items: center; gap: 10px; padding: 15px 0; }
        #shop.lock-scroll { overflow-y: hidden; }
        .shop-item { width: 110px; min-height: 90px; background: #222; border: 2px solid #444; border-radius: 10px; cursor: grab; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; transition: 0.2s; }
        .shop-item:hover { border-color: #666; }
        #wave-btn { position: absolute; top: 15px; right: 170px; padding: 12px 25px; background: #27ae60; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; z-index: 10; box-shadow: 0 4px 0 #1e8449; }
        #wave-btn:disabled { background: #333; box-shadow: 0 4px 0 #222; color: #666; }
        .tower-icon { width: 22px; height: 22px; border-radius: 4px; margin-bottom: 6px; box-shadow: 0 0 10px currentColor; }
        .sell-btn { margin-top: 10px; padding: 6px; background: #c0392b; border: none; border-radius: 4px; color: white; cursor: pointer; width: 100%; font-size: 10px; }
    </style>
</head>
<body>

    <div id="ui-top">
        <div class="stat-box">üí∞ $<span id="money">600</span></div>
        <div class="stat-box">‚ù§Ô∏è <span id="lives">20</span></div>
        <div class="stat-box">üåä Wave: <span id="wave">0</span></div>
    </div>

    <button id="wave-btn">START WAVE</button>
    <canvas id="gameCanvas"></canvas>

    <div id="shop-container">
        <div id="stats-panel"><strong>COMMAND CENTER</strong><br>Select a defense unit to see tactical data.</div>
        <div id="shop"></div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const statsPanel = document.getElementById('stats-panel');
const waveBtn = document.getElementById('wave-btn');
const shopDiv = document.getElementById('shop');

let money = 600, lives = 20, wave = 0, enemies = [], towers = [], projectiles = [], particles = [];
let isSpawning = false, draggingType = null, selectedTower = null, mousePos = { x: 0, y: 0 }, shake = 0, gridOffset = 0;

const TOWER_TYPES = {
    basic:  { color: '#3498db', range: 140, cd: 35, dmg: 18, cost: 50, desc: "Standard issue defensive unit. Balanced and reliable." },
    fast:   { color: '#f1c40f', range: 110, cd: 8,  dmg: 6,  cost: 75, desc: "High-speed rotor. Low damage but massive fire rate." },
    sniper: { color: '#e74c3c', range: 450, cd: 110, dmg: 105, cost: 150, desc: "Precision optics. Long range and high damage." },
    poison: { color: '#a29bfe', range: 130, cd: 45, dmg: 6,  cost: 100, effect: 'poison', desc: "Bio-hazard rounds. Damage over time." },
    heavy:  { color: '#d35400', range: 170, cd: 75, dmg: 140, cost: 200, desc: "Kinetic slugger. Devastating against heavy armor." },
    laser:  { color: '#1abc9c', range: 190, cd: 4,  dmg: 2, cost: 250, desc: "Thermal beam. Focused stream of energy." },
    frost:  { color: '#74b9ff', range: 120, cd: 40, dmg: 4,  cost: 125, effect: 'slow', desc: "Cryo-emitter. Slows enemy movement speed." },
    gold:   { color: '#feca57', range: 110, cd: 65, dmg: 12, cost: 300, effect: 'gold', desc: "Generates bonus cash on every hit." },
    shock:  { color: '#00d2ff', range: 160, cd: 55, dmg: 12, cost: 180, effect: 'chain', desc: "Tesla coils. Bolts arc to nearby enemies." },
    splash: { color: '#ff7675', range: 170, cd: 85, dmg: 45, cost: 220, effect: 'aoe', desc: "Fragmenting shells. Area damage." },
    vamp:   { color: '#ff4d4d', range: 135, cd: 45, dmg: 9,  cost: 210, effect: 'steal', desc: "Absorbs currency directly from targets." },
    chrono: { color: '#55efc4', range: 220, cd: 30, dmg: 2,  cost: 275, effect: 'stasis', desc: "Freezes enemies in place briefly." },
    reaper: { color: '#57606f', range: 100, cd: 65, dmg: 25, cost: 350, effect: 'exec', desc: "Kills enemies below 15% HP." },
    tesla:  { color: '#6c5ce7', range: 190, cd: 20, dmg: 50, cost: 420, desc: "High-voltage reactor. Powerful discharge." },
    wave:   { color: '#fab1a0', range: 160, cd: 100, dmg: 35, cost: 290, effect: 'expand', desc: "Sonic burst. Hits every enemy in radius." },
    miner:  { color: '#b2bec3', range: 0,   cd: 200, dmg: 0, cost: 150, effect: 'farm', desc: "Periodically grants cash bonuses." },
    inferno:{ color: '#e67e22', range: 150, cd: 5,   dmg: 1, cost: 320, effect: 'ramp', desc: "Incendiary jet. Damage ramps up." },
    hive:   { color: '#fdcb6e', range: 260, cd: 130, dmg: 12, cost: 300, effect: 'swarm', desc: "Releases homing projectiles." }
};

Object.keys(TOWER_TYPES).forEach(key => {
    const t = TOWER_TYPES[key];
    const item = document.createElement('div');
    item.className = 'shop-item';
    item.dataset.type = key;
    item.innerHTML = `<div class="tower-icon" style="background:${t.color}; box-shadow: 0 0 10px ${t.color}"></div>
                      <span style="font-weight:bold">${key.toUpperCase()}</span>
                      <span style="color:#2ecc71">$${t.cost}</span>`;
    shopDiv.appendChild(item);
});

canvas.width = window.innerWidth - 150;
canvas.height = window.innerHeight;

const path = [
    {x: -50, y: canvas.height * 0.5},
    {x: canvas.width * 0.2, y: canvas.height * 0.5},
    {x: canvas.width * 0.2, y: canvas.height * 0.2},
    {x: canvas.width * 0.8, y: canvas.height * 0.2},
    {x: canvas.width * 0.8, y: canvas.height * 0.8},
    {x: canvas.width + 50, y: canvas.height * 0.8}
];

function triggerShake(intensity) { shake = Math.max(shake, intensity); }

class Particle {
    constructor(x, y, color, vx, vy, size) {
        this.x = x; this.y = y; this.vx = vx; this.vy = vy;
        this.life = 1.0; this.decay = Math.random() * 0.03 + 0.02;
        this.color = color; this.size = size || Math.random() * 3 + 1;
    }
    update() { this.x += this.vx; this.y += this.vy; this.life -= this.decay; this.vx *= 0.95; this.vy *= 0.95; }
    draw() { ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.restore(); }
}

class Projectile {
    constructor(x, y, target, dmg, color, effect) {
        this.x = x; this.y = y; this.dmg = dmg; this.color = color; this.effect = effect;
        this.speed = 13; this.active = true;
        let dx = target.x - x, dy = target.y - y, d = Math.hypot(dx, dy);
        this.vx = (dx / d) * this.speed; this.vy = (dy / d) * this.speed;
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) this.active = false;
        for (let e of enemies) {
            if (e.hp > 0 && Math.hypot(e.x - this.x, e.y - this.y) < e.radius + 5) { this.hit(e); this.active = false; break; }
        }
    }
    hit(e) {
        e.hp -= this.dmg;
        if (this.effect === 'poison') e.poisoned = 200;
        if (this.effect === 'slow') e.slowed = 60;
        if (this.effect === 'stasis') e.slowed = 150;
        if (this.effect === 'gold') money += 3;
        if (this.effect === 'steal') money += 5;
        if (this.effect === 'exec' && e.hp < e.maxHp * 0.15) e.hp = 0;
        if (this.effect === 'aoe') {
            enemies.forEach(other => { if (Math.hypot(other.x - this.x, other.y - this.y) < 70) other.hp -= this.dmg * 0.6; });
        }
        const angle = Math.atan2(this.vy, this.vx) + Math.PI;
        for(let k=0; k<6; k++) {
            const scatter = angle + (Math.random() - 0.5) * 1.2;
            particles.push(new Particle(this.x, this.y, this.color, Math.cos(scatter)*(Math.random()*6+2), Math.sin(scatter)*(Math.random()*6+2), 2));
        }
    }
    draw() { ctx.save(); ctx.shadowBlur = 10; ctx.shadowColor = this.color; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill(); ctx.restore(); }
}

class Enemy {
    constructor(hp, isBoss = false) {
        this.x = path[0].x; this.y = path[0].y;
        this.hp = hp; this.maxHp = hp; this.isBoss = isBoss;
        this.speed = isBoss ? 0.7 + (wave * 0.02) : 1.2 + (wave * 0.03); 
        this.pathIndex = 0; this.slowed = 0; this.poisoned = 0; this.radius = isBoss ? 28 : 15;
        this.color = isBoss ? "#8e44ad" : "#2ecc71";
    }
    update() {
        if (this.poisoned > 0) { this.hp -= 0.15; this.poisoned--; }
        let s = this.slowed > 0 ? this.speed * 0.45 : this.speed;
        if (this.slowed > 0) this.slowed--;
        let target = path[this.pathIndex + 1];
        let dx = target.x - this.x, dy = target.y - this.y, d = Math.hypot(dx, dy);
        if (d < 5) { this.pathIndex++; if (this.pathIndex >= path.length - 1) { lives -= this.isBoss ? 10 : 1; this.hp = 0; triggerShake(30); return; } }
        this.x += (dx/d) * s; this.y += (dy/d) * s;
    }
    explode() {
        const count = this.isBoss ? 50 : 20;
        triggerShake(this.isBoss ? 60 : 15);
        for(let i=0; i<count; i++) {
            const angle = Math.random() * Math.PI * 2;
            particles.push(new Particle(this.x, this.y, this.color, Math.cos(angle)*(Math.random()*7), Math.sin(angle)*(Math.random()*7)));
        }
    }
    draw() {
        ctx.save();
        let drawColor = this.isBoss ? "#8e44ad" : (this.slowed > 0 ? "#74b9ff" : (this.poisoned > 0 ? "#a29bfe" : "#2ecc71"));
        ctx.shadowBlur = 15; ctx.shadowColor = drawColor; ctx.fillStyle = drawColor;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2); ctx.fill();
        if (this.hp < this.maxHp) {
            ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(this.x - 20, this.y - 25, 40, 5);
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(this.x - 20, this.y - 25, (this.hp/this.maxHp)*40, 5);
        }
        ctx.restore();
    }
}

class Tower {
    constructor(x, y, type) { 
        Object.assign(this, TOWER_TYPES[type]); 
        this.type = type; this.x = x; this.y = y; this.cooldown = 0; this.flash = 0; this.scale = 1.0; 
    }
    update() {
        if (this.flash > 0) this.flash--; 
        if (this.cooldown > 0) this.cooldown--;
        this.scale += (1.0 - this.scale) * 0.12; 
        
        if (this.cooldown <= 0) {
            if (this.effect === 'farm') { money += 25; this.cooldown = this.cd; this.flash = 10; this.scale = 0.7; return; }
            let target = enemies.find(e => Math.hypot(e.x - this.x, e.y - this.y) < this.range);
            if (target) {
                this.scale = 0.7; 
                if (this.effect === 'expand') { enemies.forEach(e => { if(Math.hypot(e.x - this.x, e.y - this.y) < this.range) e.hp -= this.dmg; }); } 
                else if (this.effect === 'swarm') { for(let i=0; i<6; i++) projectiles.push(new Projectile(this.x, this.y, {x: target.x + (Math.random()-0.5)*120, y: target.y + (Math.random()-0.5)*120}, this.dmg, this.color, null)); } 
                else { projectiles.push(new Projectile(this.x, this.y, target, this.dmg, this.color, this.effect)); }
                this.cooldown = this.cd; this.flash = 5;
            }
        }
    }
    draw() {
        ctx.save(); ctx.translate(this.x, this.y);
        // FIX: Glow now matches tower color, just brighter when flashing
        ctx.shadowBlur = this.flash > 0 ? 30 : 15; 
        ctx.shadowColor = this.color;
        ctx.fillStyle = this.color; 
        
        let s = 32 * this.scale;
        ctx.beginPath(); ctx.roundRect(-s/2, -s/2, s, s, 5); ctx.fill(); 
        
        if (selectedTower === this) {
            ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.strokeRect(-s/2 - 4, -s/2 - 4, s + 8, s + 8);
            ctx.translate(-this.x, -this.y);
            ctx.beginPath(); ctx.setLineDash([8, 4]); ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 2;
            ctx.arc(this.x, this.y, this.range, 0, Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
        }
        ctx.restore();
    }
}

function update() {
    ctx.setTransform(1, 0, 0, 1, 0, 0); 
    ctx.fillStyle = "#0a0a0c"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    if (shake > 0) { ctx.translate((Math.random() - 0.5) * shake, (Math.random() - 0.5) * shake); shake *= 0.9; if (shake < 0.1) shake = 0; }
    ctx.lineWidth = 1; ctx.strokeStyle = "rgba(0, 255, 204, 0.05)"; gridOffset = (gridOffset + 0.5) % 40;
    for (let x = gridOffset; x < canvas.width; x += 40) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
    for (let y = gridOffset; y < canvas.height; y += 40) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
    ctx.strokeStyle = "rgba(255, 255, 255, 0.07)"; ctx.lineWidth = 65; ctx.lineCap = "round"; ctx.lineJoin = "round";
    ctx.beginPath(); ctx.moveTo(path[0].x, path[0].y); path.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();
    towers.forEach(t => { t.update(); t.draw(); });
    if (draggingType) {
        const t = TOWER_TYPES[draggingType];
        ctx.beginPath(); ctx.lineWidth = 65; ctx.moveTo(path[0].x, path[0].y); path.forEach(p => ctx.lineTo(p.x, p.y));
        const onPath = ctx.isPointInStroke(mousePos.x, mousePos.y);
        const onTower = towers.some(tow => Math.hypot(tow.x - mousePos.x, tow.y - mousePos.y) < 38);
        const canPlace = !onPath && !onTower && money >= t.cost && mousePos.x < canvas.width;
        ctx.save(); ctx.beginPath(); ctx.setLineDash([8, 4]); 
        ctx.strokeStyle = canPlace ? "rgba(255,255,255,0.4)" : "rgba(231, 76, 60, 0.6)"; ctx.lineWidth = 2;
        ctx.arc(mousePos.x, mousePos.y, t.range, 0, Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
        ctx.globalAlpha = 0.5; ctx.fillStyle = canPlace ? t.color : "#e74c3c";
        ctx.beginPath(); ctx.roundRect(mousePos.x - 16, mousePos.y - 16, 32, 32, 5); ctx.fill(); ctx.restore();
    }
    enemies.forEach((e, i) => { if (e.hp > 0) e.update(); else { e.explode(); money += e.isBoss ? 500 : 25; enemies.splice(i, 1); } });
    enemies.forEach(e => e.draw());
    projectiles = projectiles.filter(p => p.active); projectiles.forEach(p => { p.update(); p.draw(); });
    particles = particles.filter(p => p.life > 0); particles.forEach(p => { p.update(); p.draw(); });
    document.getElementById('money').innerText = Math.floor(money);
    document.getElementById('lives').innerText = lives;
    document.getElementById('wave').innerText = wave;
    waveBtn.disabled = (isSpawning || enemies.length > 0);
    if (lives <= 0) { alert("Game Over!"); location.reload(); }
    requestAnimationFrame(update);
}

window.addEventListener('pointermove', (e) => {
    const rect = canvas.getBoundingClientRect();
    mousePos.x = e.clientX - rect.left; mousePos.x = Math.max(0, Math.min(canvas.width, mousePos.x));
    mousePos.y = e.clientY - rect.top;
});

document.querySelectorAll('.shop-item').forEach(item => {
    item.addEventListener('pointerdown', () => {
        draggingType = item.dataset.type;
        selectedTower = null;
        shopDiv.classList.add('lock-scroll');
        const t = TOWER_TYPES[draggingType];
        statsPanel.innerHTML = `<strong style="color:${t.color}">${draggingType.toUpperCase()}</strong><br><em>${t.desc}</em><hr style="border:0;border-top:1px solid #444">Damage: ${t.dmg}<br>Rate: ${t.cd} frames<br>Cost: $${t.cost}`;
    });
});

window.addEventListener('pointerup', () => {
    if (draggingType) {
        const t = TOWER_TYPES[draggingType];
        ctx.beginPath(); ctx.lineWidth = 65; ctx.moveTo(path[0].x, path[0].y); path.forEach(p => ctx.lineTo(p.x, p.y));
        const onPath = ctx.isPointInStroke(mousePos.x, mousePos.y);
        const onTower = towers.some(tow => Math.hypot(tow.x - mousePos.x, tow.y - mousePos.y) < 38);
        if (!onPath && !onTower && money >= t.cost && mousePos.x < canvas.width) { towers.push(new Tower(mousePos.x, mousePos.y, draggingType)); money -= t.cost; } 
        else { triggerShake(15); }
    }
    draggingType = null;
    shopDiv.classList.remove('lock-scroll');
});

canvas.addEventListener('pointerdown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    selectedTower = towers.find(t => Math.hypot(t.x - x, t.y - y) < 20);
    if (selectedTower) {
        const st = selectedTower;
        statsPanel.innerHTML = `<strong style="color:${st.color}">${st.type.toUpperCase()}</strong><br><em>${st.desc}</em><hr style="border:0;border-top:1px solid #444">Damage: ${st.dmg}<br>Rate: ${st.cd}<br><button class="sell-btn" onclick="sellTower()">SELL ($${Math.floor(st.cost/2)})</button>`;
    } else { statsPanel.innerHTML = "<strong>COMMAND CENTER</strong><br>Select a defense unit to see tactical data."; }
});

function sellTower() { if (selectedTower) { money += Math.floor(selectedTower.cost * 0.5); towers = towers.filter(t => t !== selectedTower); selectedTower = null; triggerShake(10); } }

waveBtn.onclick = () => {
    wave++; isSpawning = true;
    let count = 8 + Math.floor(wave * 1.5);
    if (wave % 10 === 0) count = 1;
    let interval = setInterval(() => {
        enemies.push(new Enemy((50 + (wave * 18)) * (wave % 10 === 0 ? 15 : 1), wave % 10 === 0));
        if (--count <= 0) { clearInterval(interval); isSpawning = false; }
    }, 800);
};

update();
</script>
</body>
</html>
